# Name : voie_4.yaml


timer:
  misha_arrosage_voie_4:
    name: Misha arrosage - Timer voie 4
    duration: "00:00:00"
    restore: true

input_number:
  misha_arrosage_duree_voie_4:  # Définit la durée d'arrosage de la voie 4
    name: Misha arrosage - Durée timer voie 4
    min: 0
    max: 1800
    step: 10
    mode: slider
    unit_of_measurement: secondes

input_text:
  misha_arrosage_dernier_declenchement_voie_4:  # Stocke la date du dernier déclenchement de la voie 4
    name: Misha arrosage - Dernier déclenchement voie 4
    min: 0
    max: 40

  misha_arrosage_volume_voie_4:  # Stocke le volume d'eau du dernier déclenchement de la voie 4
    name: Misha arrosage - Dernier volume voie 4
    min: 0
    max: 10

input_boolean:
  misha_arrosage_enable_voie_4:  # Définit si la voie 4 doit être incluse dans les séquences d'arrosage
    name: Misha arrosage - Enable voie 4

  misha_arrosage_electrovanne_virtuelle_4:
    name: "Misha Arrosage - Électrovanne Virtuelle 4"
    icon: mdi:vibrate

template:
  - switch:
      - name: "Misha arrosage - Electrovanne 4"
        unique_id: misha_arrosage_electrovanne_4
        icon: mdi:sprinkler-variant
        state: >- # Priorité à l'électrovanne réelle (via label voie_1), sinon virtuelle
          {% set data_refresh = states('sensor.misha_arrosage_data_voies') %}
          {% set reelle = label_entities('misha_voie_4') | first | default('none') %}
          {% if reelle != 'none' %}
            {{ states(reelle) }}
          {% else %}
            {{ states('input_boolean.misha_arrosage_electrovanne_virtuelle_4') }}
          {% endif %}

        availability: >- # On vérifie si le matériel réel répond
          {% set data_refresh = states('sensor.misha_arrosage_data_voies') %}
          {% set reelle = label_entities('misha_voie_4') | first | default('none') %}
          {% set virtuelle = 'input_boolean.misha_arrosage_electrovanne_virtuelle_4' %}
          {% if reelle != 'none' %}
            {{ states(reelle) not in ['unavailable', 'unknown'] }}
          {% else %}
            {{ states(virtuelle) not in ['unavailable', 'unknown'] }}
          {% endif %}
        
        turn_on:
          action: homeassistant.turn_on
          target:
            entity_id: >-
              {% set electrovanne_reelle = label_entities('misha_voie_4') | first | default('none') %}
              {{ electrovanne_reelle if electrovanne_reelle != 'none' else 'input_boolean.misha_arrosage_electrovanne_virtuelle_4' }}
              
        turn_off:
          action: homeassistant.turn_off
          target:
            entity_id: >-
              {% set electrovanne_reelle = label_entities('misha_voie_4') | first | default('none') %}
              {{ electrovanne_reelle if electrovanne_reelle != 'none' else 'input_boolean.misha_arrosage_electrovanne_virtuelle_4' }}
