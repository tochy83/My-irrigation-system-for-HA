# Name : scripts_supprimer_fichiers_zone.yaml


script:

  misha_arrosage_supprimer_fichiers_zone:
    alias: Misha Arrosage - Supprimer fichiers zone
    description: >-
      Script qui permet de supprimer les fichiers (entrées, automatisations et scripts) pour la dernière zone existante.


      Stocke le nombre de zone. Supprime le label de zone.
    sequence:
      - alias: "Reset des entités à supprimer"
        repeat:
          for_each:
            - { cible: "input_number.misha_arrosage_electrovannes_incluses_zone_", action: "input_number.set_value", valeur: 0 }
            - { cible: "input_text.misha_arrosage_nom_de_zone_", action: "input_text.set_value", valeur: "unknown" }
            - { cible: "input_boolean.misha_arrosage_programmation_zone_", action: "input_boolean.turn_off" }
            - { cible: "input_boolean.misha_arrosage_cycle_zone_", action: "input_boolean.turn_off" }
            - { cible: "input_boolean.misha_arrosage_evenements_xday_zone_", action: "input_boolean.turn_off" }
          sequence:
            - alias: "Appliquer le reset pour chaque entité définie dans la liste"
              action: "{{ repeat.item.action }}"
              target:
                entity_id: "{{ repeat.item.cible }}{{ states('input_number.misha_arrosage_nb_file_zones')|int }}"
              data: "{{ {'value': repeat.item.valeur} if 'set_value' in repeat.item.action else {} }}"

      - alias: "Suppression du label de zone si il existe"
        choose:
          - conditions:
              - alias: "Le label existe"
                condition: template
                value_template: "{{ label_id('Misha Zone ' ~ states('input_number.misha_arrosage_nb_file_zones')|int) is not none }}"
            sequence:
              - alias: "Supprimer le label de la zone (with Spook)"              
                action: homeassistant.delete_label
                data:
                  label_id: "misha_zone_{{ states('input_number.misha_arrosage_nb_file_zones')|int }}"

      - alias: "Lancer le script python de suppression des fichiers de la zone"
        action: shell_command.misha_arrosage_supprimer_fichiers_zone
        response_variable: result
      - variables: # Récupération du numéro de la zone supprimée depuis le retour du script python
          zone_supprimee: "{{ result.stdout | int }}"

      - action: logbook.log # Ecriture des événements dans les logs (Est ce vraiment nécessaire)
        data:
          name: "Suppression des entités pour la dernière zone existante"
          message: "Fichier zone_{{ zone_supprimee }}.yaml supprimé"
          entity_id: input_number.misha_arrosage_nb_file_zones
      - action: logbook.log
        data:
          name: "Suppression de l'automatisation pour la dernière zone existante"
          message: "Fichier automatisation_arrosage_zone_{{ zone_supprimee }}.yaml supprimé"
          entity_id: input_number.misha_arrosage_nb_file_zones 

      - alias: "Mettre à jour le nombre de zones"
        action: input_number.set_value
        data:
          entity_id: input_number.misha_arrosage_nb_file_zones
          value: "{{ (zone_supprimee | int) - 1 }}"

      - alias: "Définir qu'un redémarrage est nécessaire"
        action: input_boolean.turn_on
        target:
          entity_id: input_boolean.misha_arrosage_restart_needed

      - delay:
          milliseconds: 200
    mode: single
