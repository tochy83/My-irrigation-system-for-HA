# Name : scripts.yaml
# Dans ce fichier, se trouve les scripts nécessaires au fonctionnement de l'integration sauf ceux commandant les voies ou les zones d'arrosage.


script:
  arrosage_arret:
    alias: Arrosage - Arret
    icon: mdi:stop-circle-outline
    description: >-
      Script permettant l'arrêt d'un cycle d'arrosage depuis les notifications
      apparaissant sur le dashboard.
    fields:
      zone:
        selector:
          text: null
        name: zone
        required: true
    sequence:
      - variables:
          numero_zone: "{{ zone |replace ('zone ', '')}}"
      - repeat:
          for_each: >-
            {{ label_entities('Zone '~numero_zone) | select('match',
            'script.arrosage_declenchement_auto_voie') | join | replace
            ('script.arrosage_declenchement_auto_voie_','') | list }}
          sequence:
            - action: switch.turn_off
              metadata: {}
              data: {}
              target:
                entity_id: switch.arrosage_electrovanne_{{repeat.item}}
      - action: input_boolean.turn_off
        metadata: {}
        data: {}
        target:
          entity_id: input_boolean.arrosage_auto_zone_{{numero_zone}}
      - action: automation.turn_off
        metadata: {}
        data:
          stop_actions: true
        target:
          entity_id: automation.arrosage_zone_{{numero_zone}}
      - action: automation.turn_on
        target:
          entity_id: automation.arrosage_zone_{{numero_zone}}
        data: {}
      - sequence:
          - condition: state
            entity_id: input_boolean.arrosage_enable_mobileapp_notifications
            state: "on"
          - action: script.envoi_notification_vers_mon_telephone
            data:
              message: clear_notification
              tag: arrosage zone {{numero_zone}}
        alias: Notification application mobile
      - sequence:
          - condition: state
            entity_id: input_boolean.arrosage_enable_telegram_notifications
            state: "on"
          - action: telegram_bot.send_message
            data:
              message: >-
                Arrêt manuel de l'arrosage {{ as_timestamp(now()) | timestamp_custom('à %-H:%M')
                }}
              title: Arrosage - {{ state_attr('sensor.arrosage_noms_des_zones', 'zone_'~numero_zone) }}
        alias: Notification Télégram

  envoi_notification_vers_mon_telephone:
    alias: Envoi notification vers mon telephone
    icon: mdi:cellphone-information
    sequence:
      - data:
          message: "{{ message }}"
          title: "{{ title }}"
          data:
            tts_text: "{{ tts_text }}"
            color: "{{ color }}"
            tag: "{{ tag }}"
            persistent: "{{ persistent }}"
            image: "{{ image }}"
            notification_icon: "{{ icon }}"
            priority: high
            ttl: 0
        action: notify.mobile_app_sm_g960f
        #action: notify.mobile_app_mipad_5
        #action: notify.mobile_app_sm_g960f
    fields:
      message:
        selector:
          text: null
        name: Message
        required: true
      title:
        selector:
          text: null
        name: Title
      tag:
        selector:
          text: null
        name: Tag
      persistent:
        selector:
          text: null
        name: Persistent
      icon:
        selector:
          text: null
        name: Icon
      color:
        selector:
          text: null
        name: Color
      tts_text:
        selector:
          text: null
        name: TTS_text
      image:
        selector:
          text: null
        name: Image
